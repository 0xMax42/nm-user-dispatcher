#!/usr/bin/env bash
#
set -u
set -o pipefail

NMUD_DEFAULT_DISPATCH_DIR="${XDG_CONFIG_HOME:-${HOME}/.config}/networkmanager/dispatcher.d"
DISPATCH_DIR="${NMUD_DISPATCH_DIR:-${NMUD_DEFAULT_DISPATCH_DIR}}"

NMUD_NMCLI_BIN="${NMUD_NMCLI_BIN:-nmcli}"
NMUD_FIND_BIN="${NMUD_FIND_BIN:-find}"
NMUD_SORT_BIN="${NMUD_SORT_BIN:-sort}"
NMUD_DATE_BIN="${NMUD_DATE_BIN:-date}"

declare -Ag last_state
nmcli_pid=""

nmud_nmcli() {
  LANG=C LC_ALL=C "${NMUD_NMCLI_BIN}" "$@"
}

nmud_now() {
  local timestamp=""
  if ! timestamp="$("${NMUD_DATE_BIN}" '+%F %T' 2>/dev/null)"; then
    timestamp="unknown"
  fi
  printf '%s\n' "${timestamp}"
}

nmud_log_info() {
  printf '[%s] %s\n' "$(nmud_now)" "$*"
}

nmud_log_error() {
  printf '[%s] %s\n' "$(nmud_now)" "$*" >&2
}

nmud_seed_initial_state() {
  local snapshot="${1:-}"
  [[ -n "${snapshot}" ]] || return 0

  while IFS=: read -r dev state; do
    [[ -n "${dev}" ]] || continue
    state="${state%% *}"
    case "${state}" in
    connected | connecting)
      last_state["${dev}"]="connected"
      ;;
    *)
      last_state["${dev}"]="disconnected"
      ;;
    esac
  done <<<"${snapshot}"
}

nmud_state_from_message() {
  local msg="${1:-}"
  case "${msg}" in
  connecting\ *)
    printf 'connecting\n'
    ;;
  connected)
    printf 'connected\n'
    ;;
  disconnected | deactivating | "device removed")
    printf 'disconnected\n'
    ;;
  *)
    return 1
    ;;
  esac
}

nmud_state_to_event() {
  local state="${1:-}"
  case "${state}" in
  connecting)
    printf 'pre-up\n'
    ;;
  connected)
    printf 'up\n'
    ;;
  disconnected)
    printf 'down\n'
    ;;
  *)
    return 1
    ;;
  esac
}

nmud_log_transition() {
  local iface="${1}"
  local event="${2}"
  printf '[%s] %s: %s\n' "$(nmud_now)" "${iface}" "${event}"
}

nmud_notify_hooks() {
  trigger_hooks "$@"
}

nmud_apply_state_change() {
  local iface="${1}"
  local new_state="${2}"
  local old_state="disconnected"

  if [[ -v last_state["${iface}"] ]]; then
    old_state="${last_state["${iface}"]}"
  fi

  [[ "${new_state}" == "${old_state}" ]] && return 0
  last_state["${iface}"]="${new_state}"

  local event=""
  if ! event="$(nmud_state_to_event "${new_state}")"; then
    return 0
  fi

  nmud_log_transition "${iface}" "${event}"
  nmud_notify_hooks "${iface}" "${event}"
}

nmud_handle_monitor_line() {
  local line="${1:-}"
  [[ "${line}" == *"NetworkManager is running"* ]] && return 0
  [[ "${line}" == *:* ]] || return 0

  local iface="${line%%:*}"
  local msg_part="${line#*: }"
  [[ -n "${iface}" && -n "${msg_part}" ]] || return 0

  local new_state=""
  if ! new_state="$(nmud_state_from_message "${msg_part}")"; then
    return 0
  fi
  nmud_apply_state_change "${iface}" "${new_state}"
}

nmud_monitor_loop() {
  local input_fd=""
  if [[ -n "${1:-}" ]]; then
    input_fd="${1}"
  elif [[ -n "${NMCLI_MONITOR[0]:-}" ]]; then
    input_fd="${NMCLI_MONITOR[0]}"
  else
    input_fd=0
  fi

  local line=""
  while IFS= read -r -u "${input_fd}" line; do
    nmud_handle_monitor_line "${line}"
  done
}

# --- Utility: trigger dispatcher hooks ---------------------------------------
trigger_hooks() {
  local iface="$1"
  local event="$2"
  local hook_listing=""

  [[ -d "${DISPATCH_DIR}" ]] || return 0

  if ! hook_listing="$("${NMUD_FIND_BIN}" "${DISPATCH_DIR}" -maxdepth 1 -type f -perm -u+x -name "*.sh" -print | "${NMUD_SORT_BIN}")"; then
    nmud_log_error "Failed to enumerate dispatcher hooks under ${DISPATCH_DIR}"
    return 1
  fi

  [[ -n "${hook_listing}" ]] || return 0

  # Find executable .sh files, sort by name, run sequentially
  while IFS= read -r script; do
    [[ -n "${script}" ]] || continue
    if [[ -x "${script}" ]]; then
      (
        export IFACE="${iface}"
        export EVENT="${event}"
        "${script}" "${iface}" "${event}"
      ) || {
        nmud_log_error "Hook failed: ${script} (iface=${iface} event=${event})"
      }
    fi
  done <<<"${hook_listing}"
}

cleanup_nmcli() {
  if [[ -n "${nmcli_pid:-}" ]]; then
    kill "${nmcli_pid}" 2>/dev/null || true
  fi
  exit 0
}

nmud_main() {
  local initial_snapshot=""
  if ! initial_snapshot="$(nmud_nmcli -t -f DEVICE,STATE device)"; then
    printf 'Failed to read initial NetworkManager device state via nmcli\n' >&2
    return 1
  fi

  nmud_seed_initial_state "${initial_snapshot}"
  nmud_log_info "Listening for NetworkManager state changes..."

  coproc NMCLI_MONITOR { nmud_nmcli monitor; }
  nmcli_pid=$!
  trap cleanup_nmcli EXIT INT TERM

  if [[ -n "${NMCLI_MONITOR[0]:-}" ]]; then
    nmud_monitor_loop "${NMCLI_MONITOR[0]}"
  else
    nmud_monitor_loop
  fi
  wait "${nmcli_pid}"
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  nmud_main "$@"
fi
