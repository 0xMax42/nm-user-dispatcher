#!/usr/bin/env bash
#
# User-space NetworkManager event dispatcher
# Emits pre-up / up / down events with per-user hooks.
#

set -u

DISPATCH_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/networkmanager/dispatcher.d"
declare -A last_state

# --- Initial snapshot ---------------------------------------------------------
while IFS=: read -r dev state; do
  state="${state%% *}"
  case "$state" in
    connected|connecting)
      last_state["$dev"]="connected"
      ;;
    *)
      last_state["$dev"]="disconnected"
      ;;
  esac
done < <(LANG=C LC_ALL=C nmcli -t -f DEVICE,STATE device)

echo "Listening for NetworkManager state changes..."

# --- Utility: trigger dispatcher hooks ---------------------------------------
trigger_hooks() {
  local iface="$1"
  local event="$2"

  [[ -d "$DISPATCH_DIR" ]] || return 0

  # Find executable .sh files, sort by name, run sequentially
  while IFS= read -r script; do
    if [[ -x "$script" ]]; then
      (
        export IFACE="$iface"
        export EVENT="$event"
        "$script" "$iface" "$event"
      ) || {
        printf '[%s] Hook failed: %s (iface=%s event=%s)\n' \
          "$(date '+%F %T')" "$script" "$iface" "$event" >&2
      }
    fi
  done < <(find "$DISPATCH_DIR" -maxdepth 1 -type f -perm -u+x -name "*.sh" \
           -print | sort)
}

# --- Live monitoring ----------------------------------------------------------
LANG=C LC_ALL=C nmcli monitor | while read -r line; do
  [[ "$line" =~ "NetworkManager is running" ]] && continue

  iface="${line%%:*}"
  msg="${line#*: }"

  new_state=""
  case "$msg" in
    connecting\ * ) new_state="connecting" ;;
    connected ) new_state="connected" ;;
    disconnected | deactivating | "device removed" ) new_state="disconnected" ;;
    * ) continue ;;
  esac

  old_state="${last_state[$iface]:-disconnected}"
  [[ "$new_state" == "$old_state" ]] && continue
  last_state["$iface"]="$new_state"

  event=""
  case "$new_state" in
    connecting)  event="pre-up" ;;
    connected)   event="up" ;;
    disconnected) event="down" ;;
  esac

  printf '[%s] %s: %s\n' "$(date '+%F %T')" "$iface" "$event"
  trigger_hooks "$iface" "$event"
done
